<html lang="en" xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head th:replace="/client/include/head :: head">
    <meta name="_csrf" th:if="${_csrf != null}" th:content="${_csrf.token}"/>
    <meta name="_csrf_header" th:if="${_csrf != null}" th:content="${_csrf.headerName}"/>
</head>
<body>
<section th:replace="/client/include/header :: header"></section>
<div class="container py-5">
    <div class="row">
        <div class="col-12 col-lg-7">
            <div class="heading-page">
                <div class="header-page">
                    <h1>Th√¥ng tin ƒë∆°n h√†ng</h1>
                </div>
            </div>
            <div th:if="${error != null}" class="alert alert-danger" th:text="${error}"></div>
            <div th:if="${transaction == null}" class="alert alert-danger">
                Kh√¥ng t√¨m th·∫•y ƒë∆°n h√†ng. Vui l√≤ng ki·ªÉm tra l·∫°i gi·ªè h√†ng.
            </div>
            <div th:if="${transaction != null}">
                <div class="row wrapbox-content-cart">
                    <div class="cart-container">
                        <div class="cart-col-left">
                            <div class="main-content-cart">
                                <form action="" id="cartformpage">
                                    <div class="row">
                                        <div class="col-md-12 col-sm-12 col-xs-12">
                                            <table class="table-cart">
                                                <thead>
                                                <tr>
                                                    <th class="image"> </th>
                                                    <th class="px-3">T√™n s·∫£n ph·∫©m</th>
                                                    <th class="item">S·ªë l∆∞·ª£ng</th>
                                                    <th class="item">Th√†nh ti·ªÅn</th>
                                                </tr>
                                                </thead>
                                                <tbody th:if="${transaction.orders != null and not #lists.isEmpty(transaction.orders)}" id="cart-items">
                                                <tr th:each="order : ${transaction.orders}">
                                                    <td class="image">
                                                        <div class="product_image">
                                                            <a th:href="@{/client/detail(id=${order.product.id})}" th:if="${order.product != null}">
                                                                <img th:src="@{'/resources/uploads/' + ${order.product.proimage}}" th:alt="${order.product.proname}" th:if="${order.product.proimage != null}"/>
                                                            </a>
                                                        </div>
                                                    </td>
                                                    <td class="item width">
                                                        <h3>
                                                            <a th:href="@{/client/detail(id=${order.product.id})}" th:text="${order.product != null ? order.product.proname : 'Kh√¥ng c√≥ t√™n'}" th:if="${order.product != null}"></a>
                                                        </h3>
                                                    </td>
                                                    <td class="qty">
                                                        <div class="qty quantity-partent qty-click clearfix" th:attr="data-proid=${order.product != null ? order.product.id : 0},data-tstid=${transaction.id}">
                                                            <button type="button" class="qtyminus qty-btn">-</button>
                                                            <input type="text" th:value="${order != null and order.quantity != null ? order.quantity : 0}" class="tc line-item-qty item-quantity bg-white" readonly>
                                                            <button type="button" class="qtyplus qty-btn">+</button>
                                                        </div>
                                                    </td>
                                                    <td class="item">
                                                        <p>
                                                            <span class="line-item-total price" th:text="${order != null and order.price != null and order.quantity != null ? #numbers.formatInteger(order.price * order.quantity, 0, 'COMMA') + '‚Ç´' : '0‚Ç´'}"></span>
                                                        </p>
                                                    </td>
                                                </tr>
                                                </tbody>
                                                <tbody th:unless="${transaction.orders != null and not #lists.isEmpty(transaction.orders)}">
                                                <tr>
                                                    <td colspan="4" class="text-center">Kh√¥ng c√≥ s·∫£n ph·∫©m trong ƒë∆°n h√†ng</td>
                                                </tr>
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="col-12 col-md-5 col-lg-7">
                                            <div class="sidebox-group">
                                            </div>
                                        </div>
                                        <div class="col-12 col-md-7 col-lg-5">
                                            <div class="sidebox-order">
                                                <div class="sidebox-order-inner">
                                                    <div class="sidebox-order_total">
                                                        <p>T·ªïng ti·ªÅn: <span class="total-price" th:text="${totalPrice != null ? #numbers.formatInteger(totalPrice, 0, 'COMMA') + '‚Ç´' : '0‚Ç´'}"></span></p>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
                <a th:href="@{/client/index}"><span>Ti·∫øp t·ª•c mua h√†ng</span></a>
            </div>
        </div>
        <!-- Thay th·∫ø ph·∫ßn form trong HTML -->
        <div class="col-12 col-lg-5" th:if="${transaction != null}">
            <h3>Th√¥ng tin giao h√†ng</h3>
            <div class="user-info" th:if="${transaction != null}">
                <div class="user-avatar" style="background-image: url(//www.gravatar.com/avatar/6d41783bd3f3e6a071476622e6024455.jpg?s=100&d=blank);filter: progid:DXImageTransform.Microsoft.AlphaImageLoader(src='//www.gravatar.com/avatar/6d41783bd3f3e6a071476622e6024455.jpg?s=100&d=blank')">üë§</div>
                <div class="user-details">
                    <span sec:authentication="name" th:text="${#authentication.principal.user.email}"></span><br>
                    <a th:href="@{/client/logout}" class="logout">ƒêƒÉng xu·∫•t</a>
                </div>
            </div>

            <!-- Hi·ªÉn th·ªã th√¥ng b√°o l·ªói -->
            <div id="validation-error" class="alert alert-danger" style="display: none;"></div>

            <form id="orderForm" th:action="@{/client/order}" method="POST">
                <input type="hidden" th:if="${_csrf != null}" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                <input type="hidden" name="transactionId" th:value="${transaction.id}"/>

                <div class="input-group">
                    <select name="address" id="addressSelect">
                        <option value="">Ch·ªçn ƒë·ªãa ch·ªâ...</option>
                        <option value="70000, Vietnam">70000, Vietnam</option>
                        <option value="new-address">Th√™m ƒë·ªãa ch·ªâ m·ªõi...</option>
                    </select>
                </div>

                <div class="input-group">
                    <input type="text"
                           name="name"
                           id="customerName"
                           placeholder="H·ªç v√† t√™n *"
                           required
                           th:value="${#authentication.principal.user.fullName}"
                           class="form-control">
                    <div class="invalid-feedback" id="nameError"></div>
                </div>

                <div class="input-group">
                    <input type="tel"
                           name="phone"
                           id="customerPhone"
                           placeholder="S·ªë ƒëi·ªán tho·∫°i *"
                           required
                           class="form-control"
                           pattern="[0-9]{10,11}">
                    <div class="invalid-feedback" id="phoneError"></div>
                </div>

                <div class="input-group">
                    <input type="text"
                           name="addressDetail"
                           id="customerAddress"
                           placeholder="ƒê·ªãa ch·ªâ chi ti·∫øt *"
                           required
                           class="form-control">
                    <div class="invalid-feedback" id="addressError"></div>
                </div>

                <div class="payment-method">
                    <h3>Ph∆∞∆°ng th·ª©c thanh to√°n</h3>
                    <label class="payment-option">
                        <input type="radio" name="payment" value="cod" checked>
                        <img src="https://hstatic.net/0/0/global/design/seller/image/payment/cod.svg?v=6" alt="COD">
                        <span style="font-size: 14px;">Thanh to√°n khi giao h√†ng (COD)</span>
                    </label>
                    <label class="payment-option">
                        <input type="radio" name="payment" value="vnpay">
                        <img th:src="@{/resources/images/frontend/vnpay.png}" alt="VNPay" style="width: 40px; height: auto;">
                        <span style="font-size: 14px;">Thanh to√°n qua VNPay</span>
                    </label>
                </div>

                <button type="submit" name="submit" class="btn-submit" id="submitBtn">ƒê·∫∑t h√†ng</button>
            </form>
        </div>
    </div>
</div>
<section th:replace="/client/include/footer :: footer"></section>
<div th:replace="/client/include/script :: script"></div>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
    $(document).ready(function() {
        // Gi·ªØ nguy√™n code update quantity
        $('.qtyplus').click(function() {
            updateQuantity($(this), 1);
        });

        $('.qtyminus').click(function() {
            updateQuantity($(this), -1);
        });

        function updateQuantity(button, change) {
            var qtyContainer = button.closest('.qty');
            var input = qtyContainer.find('.item-quantity');
            var currentQty = parseInt(input.val()) || 0;
            var newQty = currentQty + change;
            if (newQty < 1) {
                alert('S·ªë l∆∞·ª£ng t·ªëi thi·ªÉu l√† 1');
                return;
            }
            var productId = qtyContainer.data('proid') || 0;
            var transactionId = qtyContainer.data('tstid') || 0;

            $.ajax({
                url: '/client/cart/update/' + productId,
                type: 'POST',
                data: {
                    quantity: newQty,
                    transactionId: transactionId
                },
                headers: {
                    'X-CSRF-TOKEN': $('meta[name="_csrf"]').attr('content')
                },
                success: function(response) {
                    if (response.status === 'success') {
                        input.val(response.quantity);
                        var lineItemTotal = qtyContainer.closest('tr').find('.line-item-total');
                        lineItemTotal.text(response.lineItemTotal.toLocaleString('vi-VN') + '‚Ç´');
                        $('.total-price').text(response.totalPrice.toLocaleString('vi-VN') + '‚Ç´');
                    } else {
                        alert(response.message);
                    }
                },
                error: function(xhr) {
                    alert('L·ªói khi c·∫≠p nh·∫≠t s·ªë l∆∞·ª£ng: ' + (xhr.responseJSON ? xhr.responseJSON.message : xhr.statusText));
                }
            });
        }

        // Validation function
        function validateForm() {
            let isValid = true;
            const errorDiv = $('#validation-error');
            errorDiv.hide().empty();

            // Reset previous errors
            $('.form-control').removeClass('is-invalid');
            $('.invalid-feedback').text('');

            // Validate name
            const name = $('#customerName').val().trim();
            if (!name || name.length < 2) {
                $('#customerName').addClass('is-invalid');
                $('#nameError').text('H·ªç v√† t√™n ph·∫£i c√≥ √≠t nh·∫•t 2 k√Ω t·ª±');
                isValid = false;
            }

            // Validate phone
            const phone = $('#customerPhone').val().trim();
            const phoneRegex = /^[0-9]{10,11}$/;
            if (!phone || !phoneRegex.test(phone)) {
                $('#customerPhone').addClass('is-invalid');
                $('#phoneError').text('S·ªë ƒëi·ªán tho·∫°i ph·∫£i c√≥ 10-11 ch·ªØ s·ªë');
                isValid = false;
            }

            // Validate address
            const addressDetail = $('#customerAddress').val().trim();
            if (!addressDetail || addressDetail.length < 5) {
                $('#customerAddress').addClass('is-invalid');
                $('#addressError').text('ƒê·ªãa ch·ªâ ph·∫£i c√≥ √≠t nh·∫•t 5 k√Ω t·ª±');
                isValid = false;
            }

            // Check if cart is empty
            const totalPrice = parseInt($('.total-price').text().replace(/[^0-9]/g, '')) || 0;
            if (totalPrice <= 0) {
                errorDiv.append('<p>Gi·ªè h√†ng tr·ªëng. Vui l√≤ng th√™m s·∫£n ph·∫©m tr∆∞·ªõc khi ƒë·∫∑t h√†ng.</p>');
                errorDiv.show();
                isValid = false;
            }

            if (!isValid) {
                errorDiv.append('<p>Vui l√≤ng ki·ªÉm tra v√† ƒëi·ªÅn ƒë·∫ßy ƒë·ªß th√¥ng tin.</p>');
                errorDiv.show();
                $('html, body').animate({ scrollTop: 0 }, 'fast');
            }

            return isValid;
        }

        // Form submission handler
        $('#orderForm').on('submit', function(e) {
            e.preventDefault(); // NgƒÉn submit m·∫∑c ƒë·ªãnh

            // Validate form
            if (!validateForm()) {
                return false;
            }

            const submitBtn = $('#submitBtn');
            const originalText = submitBtn.text();
            submitBtn.prop('disabled', true).text('ƒêang x·ª≠ l√Ω...');

            var paymentMethod = $('input[name="payment"]:checked').val();
            var transactionId = $('input[name="transactionId"]').val();
            var totalPrice = parseInt($('.total-price').text().replace(/[^0-9]/g, '')) || 0;

            if (paymentMethod === 'vnpay') {
                // X·ª≠ l√Ω VNPay
                $.ajax({
                    url: '/api/vnpay/create-payment',
                    type: 'POST',
                    data: {
                        amount: totalPrice,
                        orderId: transactionId,
                        orderInfo: 'Payment for order ' + transactionId
                    },
                    headers: {
                        'X-CSRF-TOKEN': $('meta[name="_csrf"]').attr('content')
                    },
                    success: function(response) {
                        if (response.status === 'OK' && response.data.paymentUrl) {
                            window.location.href = response.data.paymentUrl;
                        } else {
                            alert('L·ªói khi t·∫°o URL thanh to√°n: ' + (response.message || 'Unknown error'));
                            submitBtn.prop('disabled', false).text(originalText);
                        }
                    },
                    error: function(xhr) {
                        let errorMsg = 'L·ªói khi t·∫°o URL thanh to√°n';
                        if (xhr.responseJSON && xhr.responseJSON.message) {
                            errorMsg += ': ' + xhr.responseJSON.message;
                        }
                        alert(errorMsg);
                        submitBtn.prop('disabled', false).text(originalText);
                    }
                });
            } else {
                // X·ª≠ l√Ω COD - submit form b√¨nh th∆∞·ªùng
                const formData = $(this).serialize();
                $.ajax({
                    url: $(this).attr('action'),
                    type: 'POST',
                    data: formData,
                    headers: {
                        'X-CSRF-TOKEN': $('meta[name="_csrf"]').attr('content')
                    },
                    success: function(response) {
                        // Redirect n·∫øu th√†nh c√¥ng (controller s·∫Ω redirect)
                        if (response.redirect) {
                            window.location.href = response.redirect;
                        } else {
                            window.location.href = '/client/cart';
                        }
                    },
                    error: function(xhr) {
                        let errorMsg = 'L·ªói khi ƒë·∫∑t h√†ng';
                        if (xhr.responseJSON && xhr.responseJSON.message) {
                            errorMsg += ': ' + xhr.responseJSON.message;
                        }
                        $('#validation-error').text(errorMsg).show();
                        submitBtn.prop('disabled', false).text(originalText);
                    }
                });
            }
        });

        // Real-time validation
        $('#customerName').on('blur', function() {
            const name = $(this).val().trim();
            if (name && name.length < 2) {
                $(this).addClass('is-invalid');
                $('#nameError').text('H·ªç v√† t√™n ph·∫£i c√≥ √≠t nh·∫•t 2 k√Ω t·ª±');
            } else {
                $(this).removeClass('is-invalid');
                $('#nameError').text('');
            }
        });

        $('#customerPhone').on('blur', function() {
            const phone = $(this).val().trim();
            const phoneRegex = /^[0-9]{10,11}$/;
            if (phone && !phoneRegex.test(phone)) {
                $(this).addClass('is-invalid');
                $('#phoneError').text('S·ªë ƒëi·ªán tho·∫°i ph·∫£i c√≥ 10-11 ch·ªØ s·ªë');
            } else {
                $(this).removeClass('is-invalid');
                $('#phoneError').text('');
            }
        });

        $('#customerAddress').on('blur', function() {
            const address = $(this).val().trim();
            if (address && address.length < 5) {
                $(this).addClass('is-invalid');
                $('#addressError').text('ƒê·ªãa ch·ªâ ph·∫£i c√≥ √≠t nh·∫•t 5 k√Ω t·ª±');
            } else {
                $(this).removeClass('is-invalid');
                $('#addressError').text('');
            }
        });
    });
</script>
</body>
</html>